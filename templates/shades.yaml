- trigger:
  - platform: time_pattern
    hours: '/3'
  - platform: state
    entity_id:
    - input_datetime.shades_cold_open
    - input_number.shades_cold_close_percent
    - input_number.shades_cold_threshold
    - sensor.sun_next_rising
  action:
  - action: weather.get_forecasts
    data: { type: hourly }
    target: { entity_id: weather.home }
    response_variable: forecast
  sensor:
  - unique_id: shades_close_percent
    name: Shades - Close Percent
    unit_of_measurement: '%'
    state: >
      {% if forecast["weather.home"].forecast | map(attribute="temperature") | min < float(states("input_number.shades_cold_threshold")) %}
        {{ states("input_number.shades_cold_close_percent") }}
      {% else %}
        0
      {% endif %}
  - unique_id: shades_open_time
    name: Shades - Open Time
    device_class: timestamp
    state: >
      {% if forecast["weather.home"].forecast | map(attribute="temperature") | min < float(states("input_number.shades_cold_threshold")) %}
        {% set time = today_at(states("input_datetime.shades_cold_open")) %}
        {{ iif(time < now(), time + timedelta(days = 1), time) }}
      {% else %}
        {{ (as_datetime(states("sensor.sun_next_rising")) - timedelta(minutes = 30)).isoformat() }}
      {% endif %}
