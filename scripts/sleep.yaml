sleep_bedtime:
  alias: Sleep - Bedtime
  icon: mdi:bed-king
  mode: restart
  sequence:
  - parallel:
    - action: homeassistant.turn_off
      target:
        entity_id: >-
          {%- set basement_ignore = label_entities("Bedtime Ignore - Basement") %}
          {%- set guest_bedroom_ignore = label_entities("Bedtime Ignore - Guest Bedroom") %}
          {%- set master_bedroom_ignore = label_entities("Bedtime Ignore - Master Bedroom") %}
          {%- set on_stuff = states | selectattr("entity_id", "search", "^(fan|light|remote)") | selectattr("state", "eq", "on") | rejectattr("attributes.entity_id", "defined") | map(attribute="entity_id") | list %}
          {%- set turn_off = difference(on_stuff, iif(is_state("input_boolean.basement_guest_present", "on"), basement_ignore, [])) %}
          {%- set turn_off = difference(turn_off, iif(is_state("input_boolean.guest_bedroom_guest_present", "on"), guest_bedroom_ignore, [])) %}
          {%- set turn_off = difference(turn_off, master_bedroom_ignore) %}
          {{ turn_off | join(", ") }}
    - action: light.turn_on
      data: { brightness: '{{ iif(is_state("person.sasha_keller", "home"), 32, 160) }}' }
      target: { entity_id: light.master_bedroom_fan_lights }
    - action: lock.lock
      target:
        entity_id: '{{ states.lock | selectattr("state", "eq", "unlocked") | selectattr("entity_id", "search", "door$") | rejectattr("attributes.entity_id", "defined") | map(attribute="entity_id") | list }}'
    - action: script.garage_turn_off
    - action: script.master_bedroom_air_night
    - action: script.master_bedroom_close_shades
    - action: script.office_turn_off

sleep_good_morning:
  alias: Sleep - Good Morning
  icon: mdi:white-balance-sunny
  mode: restart
  sequence:
  - parallel:
    - if:
      - '{{ state_attr("cover.master_bedroom_shades", "current_position") < float(states("input_number.master_bedroom_shades_good_morning_open_percent")) }}'
      then:
      - action: cover.set_cover_position
        data: { position: '{{ states("input_number.master_bedroom_shades_good_morning_open_percent") }}' }
        target: { entity_id: cover.master_bedroom_shades }
    - if:
      - '{{ is_state("fan.master_bedroom_fan", "on") }}'
      then:
      - action: weather.get_forecasts
        data: { type: hourly }
        target: { entity_id: weather.home }
        response_variable: forecast
      - if:
        - '{{ forecast["weather.home"].forecast[:24] | map(attribute="temperature") | min > float(states("input_number.shades_cold_threshold")) }}'
        then:
        - action: fan.turn_off
          target: { entity_id: fan.master_bedroom_fan }
    - if:
      - '{{ is_state("switch.master_bed_switch_b", "on") }}'
      then:
      - action: switch.turn_off
        target: { entity_id: select.master_bed_switch_b }
    - if:
      - '{{ not is_state("alarm_control_panel.konnected_alarm", "disarmed") }}'
      then:
      - action: alarm_control_panel.alarm_disarm
        target: { entity_id: alarm_control_panel.konnected_alarm }

sleep_good_night:
  alias: Sleep - Good Night
  icon: mdi:sleep
  mode: restart
  sequence:
  - parallel:
    - action: light.turn_off
      target:
        entity_id:
        - light.master_bedroom_closet_lights
        - light.master_bedroom_fan_lights
        - light.master_bedroom_lights
    - if:
      - '{{ is_state("person.sasha_keller", "home") }}'
      then:
      - action: cover.set_cover_position
        data: { position: 6 }
        target: { entity_id: cover.master_bedroom_shade_a }
    - if:
      - '{{ is_state("person.samuel_kadolph", "home") }}'
      then:
      - action: fan.set_percentage
        data: { percentage: 75 }
        target: { entity_id: fan.master_bedroom_pedestal_fan }
        enabled: false
    - if:
      - '{{ is_state("alarm_control_panel.konnected_alarm", "disarmed") }}'
      then:
      - choose:
        - conditions:
          - '{{ is_state("input_boolean.sleep_good_night_arms_alarm_home", "on") }}'
          sequence:
          - action: alarm_control_panel.alarm_arm_home
            target: { entity_id: alarm_control_panel.konnected_alarm }
        - conditions:
          - '{{ is_state("input_boolean.sleep_good_night_arms_alarm_away", "on") }}'
          sequence:
          - action: alarm_control_panel.alarm_arm_away
            target: { entity_id: alarm_control_panel.konnected_alarm }

sleep_preheat_bed:
  alias: Sleep - Preheat Bed
  icon: mdi:radiator
  mode: single
  sequence:
  - action: select.select_option
    data: { option: '{{ int(states("input_number.master_bedroom_air_night_bed_heat")) }}' }
    target: { entity_id: select.master_bed_level_b }
